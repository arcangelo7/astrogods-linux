name: Build Flatpak

on:
  push:
    tags:
      - '*.*.*'
  workflow_dispatch:

jobs:
  generate-manifest:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0

      - name: Update flatpak-flutter.yml with tag
        run: |
          sed -i "s/VERSION_PLACEHOLDER/${{ github.ref_name }}/g" flatpak-flutter.yml

      - name: Run flatpak-flutter preprocessor
        run: |
          docker run --rm \
            -v "$PWD":/usr/src/flatpak \
            -u $(id -u):$(id -g) \
            theappgineer/flatpak-flutter:latest \
            flatpak-flutter.yml

      - name: Restore VERSION_PLACEHOLDER in input manifest
        run: |
          sed -i "s/${{ github.ref_name }}/VERSION_PLACEHOLDER/g" flatpak-flutter.yml

      - name: Commit generated manifest
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add it.astrogods.AstroGods.yml pubspec-sources.json flutter-sdk-*.json flutter-shared.sh.patch printing/*-CMakeLists.txt.patch
          git commit -m "chore: update Flatpak manifest for ${{ github.ref_name }}" || echo "No changes"
          git push origin main

      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create ${{ github.ref_name }} \
            --title "AstroGods ${{ github.ref_name }}" \
            --notes "Source build release for Flathub"
